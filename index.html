<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Document</title>
  <link rel="stylesheet" href="./css/index.css" />
  <link rel="stylesheet" href="./css/iconfont.css" />
  <link rel="stylesheet" href="./css/player.css">
  <link rel="stylesheet" href="./css/results.css">
  <link rel="stylesheet" href="./css/comment.css">
  <link rel="stylesheet" href="./css/video.css">
</head>

<body>
  <div id="player">
    <h2 class="title">黑云音乐</h2>
    <div class="search">
      <input type="text" v-model.trim='search' @keyup.enter='searchmusic' />
      <button @click="searchmusic">
        <span class="iconfont icon-search"></span>
      </button>
    </div>
    <div class="tab-wrapper">
      <!-- tab栏 -->
      <!-- <div class="tab-bar"> -->

      <!-- 使用 router-link 组件来导航. -->
      <!-- 通过传入 `to` 属性指定链接. -->
      <!-- <router-link> 默认会被渲染成一个 `<a>` 标签 -->
      <!-- 声明式导航 -->
      <!-- <router-link :to="'/results/'+search" class="bar-item " active-class='active'>搜索结果</router-link> -->
      <!-- <router-link :to="'/results/'+search" class="bar-item " active-class='active'>搜索结果</router-link>
        <router-link :to='"/playing/"+id' class="bar-item " active-class='active'>歌曲播放</router-link>
        <router-link to="/video" class="bar-item " active-class='active'>mv</router-link>
        <router-link to="/comment" class="bar-item " active-class='active'>歌曲评论</router-link> -->


      <!-- </div> -->
      <!-- 对应的内容区域 -->
      <div class="tab-content">
        <!-- 路由出口 -->
        <!-- 路由匹配到的组件将渲染在这里 -->
        <router-view></router-view>
      </div>
    </div>
  </div>


  <script src="./lib/vue.js"></script>
  <script src="./lib/vue-router.js"></script>
  <script src="./lib/axios.js"></script>
  <script src="./lib/moment.js"></script>
  <!-- 评论 -->
  <script id="comment" type="text/html">
    <div class="comment-wrapper">
      <div class="items" >
        <div class="item"v-for='item in commentList'>
          <div class="left">
            <img :src="item.user.avatarUrl" alt="">
          </div>
          <div class="right">
            <div class="top">
              <span class='user'>{{item.user.nickname}}:</span>
              <span
                class='content'>{{item.content}}</span>
            </div>
            <div class="bottom">
              <div class="time">{{item.time | monment}}</div>
              <div class="like-wrapper">
                <span>👍</span>({{item.likedCount}})
              </div>
            </div>
          </div>
        </div>
        
        </div>
        
      </div>
    </div>
  </script>
  <!-- 播放 -->
  <script id="playing" type="text/html">
    <div class="player">
      <div class="left">
        <img class='disc' src="./img/disc.png" alt="">
        <img class='cover' :src="coverUrl" alt="">
      </div>
      <div class="right">
        <div class="title"><img src="./img/tag.png" alt=""><span>{{songName}}</span> </div>
        <div class="singer">歌手: <span>{{singerName}}</span></div>
        <div class="album">所属专辑: <span>{{albumName}}</span></div>
        <audio class='audio' controls :src="musicUrl" autoplay loop></audio>
        <ul class='lyric-container'>
          <li class='lyric' v-for='item in lyric'>{{item}} </li>

        </ul>
      </div>
    </div>
  </script>
  <!-- 搜索列表 -->
  <script id="results" type="text/html">
    <div class="result-wrapper">
      <div class="song" v-for="item in songList">
        <div class="name">
          <span class="iconfont icon-play" @click='toplaymusic(item.id)'></span>
          {{item.name}}
          <span class="iconfont icon-editmedia" v-if='item.mvid != 0' @click='toMV(item.mvid)'></span>
          <span style='color:hotpink'  @click='tocomment(item.id)'> 热门评论</span>
        </div>
        <div class="singer">{{item.artists | singer}}</div>
        <div class="album">《{{item.album.name}}》</div>
        <div class="time">{{item.duration | gettime}}</div>
      </div>

    </div>
  </script>
  <!-- mv播放 -->
  <script id="video" type="text/html">
    <div class="video">
      <div class="title-wrapper">
        <span class='tag'>MV</span>
        <span class='title'>{{mvName}}</span>
        <span class='artist'>{{mvArtist}}</span>
      </div>
      <video :src="mvUrl" controls autoplay loop></video>
    </div>
  </script>

  <script>
    //1.定义路由组件
    //评论
    const comment = {
      template: '#comment',
      data(){
        return {
          commentList:[]
        }
      },
      created(){
   
        axios
        .get(
          `https://autumnfish.cn/comment/hot?id=${this.$route.params.id}&type=0`
        )
        .then(backData => {
             
          console.log(backData.data.hotComments);
          this.commentList = backData.data.hotComments;
        });
        
      },
      filters:{
        monment(val){
          let str = moment(val).format('YYYY-MM-DD HH:mm:ss');
          return str;
        }
      }
    }
    //歌曲播放
    const playing = {
      template: '#playing',
      data() {
        return {
          musicUrl: '',
          coverUrl: '',
          albumName: '',
          singerName: '',
          songName: '',
          lyric: []

        }
      },
      created() {
        console.log(this.$route.params.id);
        //获取歌曲url
        axios.get('https://autumnfish.cn/song/url?id=' + this.$route.params.id).then(data => {
          console.log(data);
          this.musicUrl = data.data.data[0].url
        }).catch()


        // 调用接口 获取 歌曲信息
        axios
          .get(`https://autumnfish.cn/song/detail?ids=${this.$route.params.id}`)
          .then(backData => {
            // console.log(backData)
            // 封面地址
            this.coverUrl = backData.data.songs[0].al.picUrl;
            // 专辑名
            this.albumName = backData.data.songs[0].al.name;
            // 歌手名
            this.singerName = backData.data.songs[0].ar[0].name;
            // 歌名
            this.songName = backData.data.songs[0].name;
          });

        // 歌词
        axios
          .get(`https://autumnfish.cn/lyric?id=${this.$route.params.id}`)
          .then(backData => {
            console.log(backData)
            // 保存歌词为数组
            this.lyric = backData.data.lrc.lyric.split('\n');
            // 循环数组 切掉 [00:00.000]
            for (let i = 0; i < this.lyric.length; i++) {
              this.lyric[i] = this.lyric[i].slice(11);
            }
          });
      }
    }
    //搜索列表组件
    const results = {
      template: '#results',
      data() {
        return {
          songList: []
        }
      },
      filters: {
        singer(val) {
          let singname = '';
          for (let i = 0; i < val.length; i++) {
            singname += val[i].name;
            singname += '|';
          }
          singname = singname.slice(0, -1);
          return singname;
        },
        gettime(time) {
          let min = ~~(time / 1000 / 60) < 10 ? '0' + ~~(time / 1000 / 60) : ~~(time / 1000 / 60);
          let sec = ~~(time / 1000 % 60) < 10 ? '0' + ~~(time / 1000 % 60) : ~~(time / 1000 % 60);
          return min + ':' + sec;
        }
      },
      created() {
        console.log(this.$route.params.search);
        //获取歌曲列表
        axios
          .get(
            `https://autumnfish.cn/search?keywords=${this.$route.params.search}`
          )
          .then(backData => {
            console.log(backData.data.result.songs)
            // 保存歌曲列表
            this.songList = backData.data.result.songs;
          });
      },
      methods: {
        toplaymusic(id) {
          router.push('/playing/' + id); //其中的数据对应上面的 占位符
        },
        toMV(id) {
          router.push('/video/' + id); //其中的数据对应上面的 占位符
        },

        tocomment(id) {
          router.push('/comment/' + id); //其中的数据对应上面的 占位符
        }

      },

    }
    //mv播放
    const video = {
      data(){
        return{
          mvName:'',
          mvUrl:'',
          mvArtist:'',
        }
      },
      template: '#video',
      created(){
        console.log(this.$route.params.mvid);
        
        axios
        .get(`https://autumnfish.cn/mv/detail?mvid=${this.$route.params.mvid}`)
        .then(backData => {
          console.log(backData)
          this.mvName = backData.data.data.name;
          this.mvUrl = backData.data.data.brs['240'];
          this.mvArtist = backData.data.data.artistName;
        });
      }

    }
    //2.定义路由
    //每个路由映射一个组件
    const routes = [{
      path: '/comment/:id',
      component: comment
    }, {
      path: '/playing/:id',
      component: playing
    }, {
      path: '/results/:search', //动态路由匹配 search 占位
      component: results
    }, {
      path: '/video/:mvid',
      component: video
    }, ]

    //3.创建router实例 传'routes'配置
    const router = new VueRouter({
      routes
    })

    const app = new Vue({
      el: '#player',
      router,
      data: {
        search: ''
      },
      methods: {
        searchmusic() {
          console.log(this.search);
          // router.push('地址') 编程式导航 
          router.push('/results/' + this.search); //其中的数据对应上面的key占位符
          //动态路由匹配
          window.location.reload();
        }
      },
      computed: {}
    })
  </script>
</body>

</html>